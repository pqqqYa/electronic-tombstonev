# 数据链路层


- 数据链路层的功能
- 组帧
- 差错控制
	- 检错编码
	- 纠错编
- 流量控制与可靠传输机制
	- 流量控制、可靠传输与滑动窗口机制
	- 停止-等待协议
	- 后退N帧协议（GBN）
	- 选择重传协议（SR）
- 介质访问控制
	1. 信道划分:频分复用、时分复用、波分复用、码分复用
	2. 随机访问:ALOHA 协议:CSMA协议:CSMA/CD协议:CSMACA
	3. 轮询访问:令牌传递协议
- 局域网
	- 局域网的基本概念与体系结构
	- 以太网与IEEE 802.3
	- IEEE 802.11 无线局域网
	- VLAN的基本概念与基本原理
- 广域网
	- 广域网的基本概念
	- PPP协议
- 数据链路层设备
	- 以太网交换机及其工作原理




## 1 点对点信道

### 1.1 概念体系
- 数据链路
	- 相邻节点传送数据报的逻辑通道
- 链路
	- 节点间传输介质的物理连接（如$双绞线 \rightarrow 光纤 \rightarrow 微波$）
	- 按介质分类：双绞线、光纤、微波
	- 有线链路、无线链路
- 节点
	- 主机+路由器
- 帧
	- 封装网络层数据报
	- 协议数据单元

## 2 数据链路层的功能概述

1. 为网络层提供服务
2. 链路管理
3. 封装成帧（组帧）
4. 差错控制
5. 流量控制
6. 可靠传输
7. 介质访问控制

### 2.1 为网络层提供服务
- 三种服务
	1. 确认的无连接服务
	2. 有确认的无连接服务
	3. 有确认的面向连接的服务
- 作用
	- 加强物理层传输原始bit流的功能，修正为逻辑上无差错的数据链路

### 2.2 链路管理

- 数据链路层连接的建立、维持和释放过程

### 2.3 封装成帧（组帧）

#### 2.3.1 定义

- 给一段数据的前后分别添加首部和尾部

#### 2.3.2 概念
1. **帧长**：
	- 帧的数据部分长度加上首部和尾部的长度
	- 帧的数据部分 MTU 长度需要大于首部和尾部
2. **最大传输单元 MTU**：
	- 一个链路层数据帧能承载的最大数据量（$MTU = 1500\ \text{B}$）
	- MTU长度需要大于首部和尾部
	- 帧的数据部分
	- 以太网的MTU=1500B
3. **帧定界**：
	 - 确定帧的界限
	 - 帧定律：$01111110$（十六进制 $0x7E$）
4. **帧同步**：
	- 接收方能够从二进制流中识别帧的起始与终止
	- 需去除"定界"附加信息并恢复数据原貌
5. **透明传输**：
	- 无论数据内容如何组合，均能无差错传输
	- 接收方要能够去除“帧定界”的附加信息，把帧“恢复原貌”


#### 2.3.3 实现组帧的4种方法

##### 实现组帧的4种方法

1. 字符计数法：
	- 在帧首部使用一个计数字段来记录该帧所含的字节数（如 `SOH` 开头）
	- 缺陷
		- 任何一个计数字段出错，都会导致后续所有帧无法定界
		- 若计数字段出错（失去帧边界划分的依据），接收方无法判断传输帧的结束位和下一帧的开始位，失去同步
	- ![](attachment/组帧-字符计数法.png)

2. 字节填充法：
   - 字符
	- 控制字符
		- SOH（strat of header）：帧的最前面
		- EOT（end of transmission）：帧的末尾
	- 转义字符
		- ESC：放置在特殊字符的前面，防止特殊字符被误判为帧的首尾界定符
	- 图示![](attachment/组帧-字节填充法.png)

3. 零比特填充法：
	- 在HDLC协议中使用
	- 定义：使用特殊字符0111110来标志帧的开始和结束
	- 发：遇到5个连续的1，就自动在其后插入一个0
	- 收：收到5个连续的1，就自动删除后面紧跟的0
	- 图示![](attachment/组帧-零比特填充法.png)
	- 口诀：五一一零
4. 违规编码法：
	- 使用违规编码序列来界定帧的起始和终止
	- 适用于冗余编码和特殊编码环境
	- 局域网IEEE802标准采用

##### 市场使用情况

- 常用
	- 零比特填充法
	- 违规编码法
- 不常用
	- 字符计数法：计数字段的脆弱性
	- 字节填充法：复杂性、不兼容
### 2.4 差错控制

#### 2.4.1 差错

- 位错：某些位出现差错
	- 常见错误：比特差错（1变成0，0变成1）
- 帧错：帧丢失、帧重复或帧失序（传输错误）

#### 2.4.2 差错控制分类

- 自动重传请求ARQ（检错**编码**）
	- 奇偶校验码
	- 循环冗余校验码
- 前向纠错FEC（纠错编码）
	- 海明码

#### 2.4.3 奇偶校验编码
- 组成: n-1位数据，1位校验码
- 原理: 整个检验码中的“1”的个数为奇数或偶数
- 分类:
	- 奇校验码: 1的个数为奇数
	- 偶校验码: 1的个数为偶数
- 快捷计算: 所有位一起，异或为0
- 案例1001101：
	- 奇校验码: 1001101**1**
	- 偶校验码: 1001101**0**




#### 2.4.4 循环冗余编码 (CRC)
##### I. 概念
- k位位串表示k-1的多项式的序数系列
- 数据：m位
- 帧检验序列 (FCS) (r位的余码)
- 帧: m+r位组成

##### II. 计算过程
1. 双方约定多项式 $G(X)$（最高位和最低位均为1）
	1. k位位串表示k-1的多项式的序数系列
    2.  $x^2 + x^2 + 1$ 表示位串 1101，4位 $k=4$
    3. ![](attachment/循环冗余编码%20(CRC)计算过程.png)
2. 余码附带在数据后面
3. 使用 MySQL 计算收到的数据和余码是否有差错

##### III. 特点
- 由硬件实现，处理非常迅速，不会影响数据传输
- 凡是接收方数据链路段承受的帧仍无差错（错的都丢了）
- CRC 有纠错功能，但是一般不用，错误的直接丢弃

#### 2.4.5 海明码

##### I. 原理
		
- 异或为0，偶校验

##### II. 海明距离/海明距/码距
- 一个有效编码集中，任意2个合法编码（码字）的海明距离的最小值称为该编码集的海明距离（码距）
- 检测 $d$ 位错，码距 $d+1$
- 纠正 $d$ 位错，码距 $2d+1$

##### III. 过程

1. 确定海明码位数r
	- $n$ 为有效信息
	- $k$ 为检验位的位数（校验码有$2^k$种取值）
	- 海明不等式（$n+k≤2^k-1$）
2. 确定校验位的分布（检验位$P_i$在海明位号为$2^{i-1}$的位置上）
3. 分组形成检验关系
4. 检验取值

### 2.5 流量控制


#### 2.5.1 数据链路层和传输层具有流量控制机制
- 不同协议中
	- TCP/IP中这个功能在传输层
	- OSI体系中才有
- 不同层的功能不一样
	- 数据链路层
	    - 控制的相邻结点之间的流量
	    - 接收方收不下就不返回确认
	- 传输层
	    - 控制的端到端的流量
	    - 接收方通过确认报文段中的窗口值来调整发送方的发送窗口

#### 2.5.2 分类
##### I. 停止-等待流量控制（一种特殊的滑动窗口机制）
- 发送发每次只允许发送一个帧
- 接收方每接收一个帧都要反馈一个信号
- 发送方收到应答才能发送发下一帧


##### II. 滑动窗口流量控制
- 实现流量控制与可靠传输
- 概念
	- 发送窗口
	    - 发送方维持的一组连续的允许发送帧的序号
        - 正在发送的数据
- 分类
    - 单帧滑动窗口
        - 停止-等待流量控制S-W
    - 多帧滑动窗口
        - 后退N帧协议GBN
        - 选择重传协议SR
- 滑动窗口的特征
    1. 只有接收窗口向前滑动，发送窗口才可以向前滑动
    2. 3种协议在窗口大小上有所区别
	    - 停止-等待协议：发送窗口 $W_T=1$，接收窗口 $W_R=1$
	    - 后退N帧协议：发送窗口 $W_T>1$，接收窗口 $W_R=1$
	    - 选择重传协议：发送窗口 $W_T>1$，接收窗口 $W_R>1$
    3. 接受窗口大小为1时，可保证帧的有序接收
    4. 窗口大小在传输过程中的大小是固定的

#### 2.5.3 滑动窗口协议的数据传输速率的计算

- 信道平均（实际）数据传输速率=信道利用率×信道带宽（最大数据传输速率）
- 信道平均（实际）数据传输速率=发送周期内发送的数据量/发送周期


### 2.6 可靠传输

#### 2.6.1 定义

- 发送方发送的数据被接收方正确地接收

#### 2.6.2 概念

- 确认：发送方发回一个确认帧
- 超时重传：规定时间内没有接收到所发数据的确认帧，则重发该数据帧，直到发送成功为止
- 丢包：物理线路故障、设备故障、病毒攻击、路由信息错误等原因造成数据包丢失
- 自动重传请求ARQ（**协议**）
- **信道利用率**

#### 2.6.3 自动重传请求ARQ（协议）

##### I. 特点

重传是自动进行的

##### II.分类

1. **S-W停止-等待协议**
   - 差错类型
     - 数据帧丢失/帧出错
       - ACK丢失/迟到
         - 发送方收不到确认帧，重传确认帧
   - 概念
     - 帧缓冲区
	    - 为了超时重传和判定的需要
	    - 接收方和发送方都需要设置
     - 超时计时器
	    - 设置的重传时间应当比帧传输的平均RTT更长一些
     - 确认帧
	    - ACK0和ACK1
   - 特征
     - 信道利用率低
     - 简单
   - 注意
     - 发送完一个帧之后必须保留他的副本
     - 数据帧和确认帧必须编号


2. **GBN后退N帧协议**
   - 定义
     - **累积确认**（偶尔捎带确认）
	    - 连续收到多个正确的数据帧后，对最后一个数据帧发回确认信息
	    - ACKn表示对n号帧的确认
     - 接收方只按顺序接收帧，不按序的丢弃
     - 确认序列号最大的、按需到达的帧
     - 发送窗口最大为$2^n-1$，接收窗口的大小为1
   - 概念
	- 发送窗口
	     - n比特对帧编号
	     - $1 \leq W_T \leq 2^{n-1}$
	- 接收窗口
	    - $W_R = 1$
   - 特征
     - 降低传输效率
     - 信道误码率较大的时候，GBN不一定优于S-W


3. **SR选择重传协议**
   - 定义
	   - 等到所缺序号的数据帧收齐后，再一并送交上层
     - SR接收方来者不拒，失序的被缓存，确认一个正确接收的帧

   - **概念**
	   - 否定帧NAK
	       - 要求发送方立刻重传NAK指定的数据帧
     - 发送窗口&接收窗口
	     - 大于1
	     - n比特对帧编号
		     - $W_R + W_T \leq 2^n$
		     - $W_{Rmax} + W_{Tmax} = 2^{n-1}$
		     - $W_R \leq W_T$


#### 2.6.4 信道利用率

##### I. 定义

- 有效发送数据的时间与整个发送周期之比

##### II.不同协议下的计算

- 停止-等待协议S-W
	- 计算公式：$U=\frac{T_D}{T_D+RTT+T_A}$
	- $T_D$分组发送时延
	- $RTT$往返时延
	- $T_A$发送时延通常忽略不计
	- 当RTT大于$T_D$时，信道利用率就非常低
- 连续ARQ协议的信道通信利用率
	- 计算公式：$U=\frac{nT_D}{T_D+RTT+T_A}$
	- $T_D$分组发送时延
	- $RTT$往返时延
	- 发送窗口n个分组
### 2.7 介质访问控制

#### 2.7.1 定义

1. 隔离来自同一信道上其他结点所传送的信号
2. 使用同一传输介质的多个设备的通信隔离开来，把时域和频域资源合理地分配给这些设备

#### 2.7.2 MAC介质访问控制子层

- 决定广播信道中信道分配的协议

#### 2.7.3 概念

- 复用：多个发送方的信号组合在一条物理信道上进行传输
- 共享信道：1个链路，N个信道

#### 2.7.4 分类

- 静态划分信道
	- **信道划分介质访问控制**
- 动态划分信道
	- **轮询访问介质访问控制**
	- **随机访问介质访问控制（争用型协议）**

##### 信道划分介质访问控制

1. FDM频分多路复用
	- 定义
	- 概念
		- 子频带
		- 隔离带
		- 复用器
		- 分用器
	- 优点

2. TDM时分多路复用
- 定义
- 概念
	- TDM帧
	- TDM长度
- STDM统计时分复用（异步时分复用）
	- 定义
	- 优点
	- 相较于TDM

3. WDM波分多路复用
- 概念
- 定义

4. CDM码分多路复用
- 概念
	- 码分多址CDMA
	- 码片Chip
- 解决问题
	- 给各节点分配专属“码片序列”
	- 发送方如何发送数据
	- 信号在传输过程中叠加
	- 接收方如何接收数据
- 优点
- 应用


## 3 局域网



### 3.1 局域网的基本概念
- 定义
- 特点
- 三要素


### 3.2 局域网的体系结构

- 三种特殊局域网
	1. 以太网
	2. 令牌
	3. FDDI


### 3.3 以太网和IEEE802.3

- 传输介质
- MAC地址
- MAC帧


### 3.4 IEEE802.11无线局域网

- 组成
	- 有固定基础设施无线局域网
	- 无固定基础设施移动自组织网络
- MAC帧
	- 3种类型
		1. 数据帧（MAC首部、帧主体、帧检验序列FCS）
		2. 控制帧
		3. 管理帧
	- 记忆口诀


### 3.5 虚拟局域网VLAN
- 概念
	- 802.1Q帧（VLAN的重要组成）
	- VID
	- 干线链路（汇聚链路）
- 3种划分方式（不同的VID映射关系）
	1. 基于接口
	2. 基于MAC地址
	3. 基于IP地址


## 4 广域网

### 4.1 概念

- 广域网
- 结点交换机
- 链路

### 4.2 广域网和局域网的区别与联系

### 4.3 PPP点对点通讯协议

- 三个组成部分
- 应满足的要求
- 无需满足的要求


## 5 设备

### 5.1 以太网交换机

#### 5.1.1 2种交换模式

- 直接交换方式
- 存储转发交换方式

#### 5.1.2 交换机的自学习功能

- 交换表
- 自学习过程