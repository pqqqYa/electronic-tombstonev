# 网络层

- 网络层的功能
	- 异构网络互连
	- 路由与转发
	- SDN基本概念
	- 拥塞控制
- 路由算法
	- 静态路由与动态路由
	- 距离-向量路由算法
	- 链路状态路由算法
	- 层次路由
- **IPv4**
	- IPv4 分组
	- IPv4 地址与NAT
	- 子网划分与子网掩码、CIDR、路由聚合、ARP、DHCP与ICMP
- IPv6
	- IPv6 的主要特点
	- IPv6 地址
- **路由协议**
	- 自治系统
	- 域内路由与域间路由
	- RIP路由协议
	- OSPF路由协议
	- BGP路由协议
- IP 多播
	- 多播的概念
	- IP 多播地址
- 移动 IP
	- 移动 IP 的概念
	- 移动 IP 通信过程
- **网络层设备**
	- 路由器的组成和功能
	- 路由表与路由转发

## 1 网络层功能

### 1.1 异构网络互联

#### 1.1.1 何为异构？

每个网络的拓扑结构不同、物理层&链路层的实现不同、主机类型也各不相同

#### 1.1.2 重要设备

路由器（Router）/网关（Gateway）

在TCP/IP文献中，路由器称之为网关（Gateway）

### 1.2 路由转发

### 1.3 路由

各个路由器之间相互配合，规划IP数据报（分组）的最佳转发路径

各个路由器需要运行“**路由协议**”，最终生成各自的“**路由表**“

### 1.4 转发

一台路由器，根据自己的“转发表”，将收到的IP数据报从合适的接口转发出去

转发表=精简版路由表。更精简的数据结构有助于快速检索

### 1.5 拥塞控制

#### 1.5.1 拥塞

- 原因：网络上出现过量分组，超负荷，引起网络性能下降
- 现象：网络上的分组增加，但吞吐量反而降低

#### 1.5.2 拥塞控制

- 开环控制（静态的方法）
	- 在部署网络时，就提前设计好预防拥塞的方法。一旦网络系统开始运行，就不再修改
- 闭环控制（动态的方法）
	- 动态监视网络状态，及时发现哪里发生拥塞，并将拥塞信息传递给相关路由器（如：通过ICMP）
	- 相关路由器及时调整“路由表”

### 1.6 SDN

## 2 IPv4

### 2.1 IPv4分组（数据报）

![]（attachment/IPv4分组（数据报）格式.png）

#### 2.1.1 IPv4分组格式
- 首部
	- 固定部分：20B
		1. 版本：区分网络层使用的IP协议版本（v4/v6）
		2. 首部长度：表示整个首部的长度，4bit表示了0~15，**单位为x4B**，即首部最大长度为 $X4B \times 15 = 60B$
		3. 区分服务：无需理会
		4. 总长度：表示首部+数据部分总长度，**单位x1B**
		5. 标识：由IP数据包的“源主机”生成，通常是自增序列
		6. 标志
			- 最低位MF：0表示这是最后一个分片，1表示后面还有分片
			- 次低位DF：0允许分片，1不允许分片
			- 最高位：无需理会
		7. 片偏移：表示在“被分片前”的位置，**单位为x8B**
		8. 生存时间（TTL）：数据报在网络中可通过的路由器数的最大值
		9. 协议：TCp协议服务值为6，UDP协议服务值为17
		10. 首部检验和
			- 每个路由器仅校验首部，而不校验数据部分
			- 如果该字段设为全0，表示不用校验
			- 校验和的计算方法与UDP相同
		11. 源地址：发送方地址
		12. 目的地址：接收方地址
	- 可变部分：0~40B
		1. 可选字段
		2. 填充
- 数据部分：实际传输过程中，“数据部分”的长度受下一段链路的最短/最长帧长限制

#### 2.1.2 IP数据报分片

最大传送单元MTU：一个链路层数据帧能承载的最大数据量，以太网的MTU=1500B

如果一个IP数据报的总长度超出了下一段链路的MTU，就需要路由器将其分片

每个分片都是一个可以被单独转发的IP数据报，都包含首部

##### 注意点

1. IP数据报的“分片”可能在源主机、或任何一个路由器中发生
2. 只有目的主机才会对分片进行“重组”
3. 各分片有可能乱序到达目的主机
4. 由于首部的“片偏移”字段是以x8B为单位，因此，==除了最后一个分片外，其他每个分片的数据部分必须是8B的整数倍==

#### 2.1.3 IP数据报TTL字段

TTL的初始值通常由源主机设置。每经过一个路由器，路由器就将TTL减1，如果TTL减到0，就直接丢弃分组，并向源主机发送ICMP报文（通知出现异常）。

### 2.2 IP地址

#### 2.2.1 IP地址分类

![]（attachment/最初的IPv4地址.png）

- 单播地址
	- A类1~126
	- B类128~191
	- C类192~223
- 多播地址
	- D类224~239

#### 2.2.2 IP地址结构

IP地址的两级结构：<网络号><主机号>

网络号不定长，可根据前几个比特判断类别，从而 推测出网络号占多少位，进而判断类型

| 开头   | 类型  |
| ---- | --- |
| 0    | A类  |
| 10   | B类  |
| 110  | C类  |
| 1110 | D类  |
| 1111 | E类  |

#### 2.2.3 IP地址的分配

1. 每台主机、每个路由器接口被分配的IP地址都是全球唯一的
2. 路由器和路由器连接的接口可以不分配IP地址，但路由器和其他节点连接的接口必须分配IP地址
3. 从属于同一个网络的所有主机、路由器接口的IP地址“网络号”都相同
4. 当一台新主机接入网络时，需要给它分配一个IP地址、并配置“默认网关”（路由器的IP地址）
5. IP地址资源分配不灵活，利用率低，有限的IP地址资源将很快耗尽

### 2.3 子网划分

#### 2.3.1 子网划分

主机号占n bit，将前k bit抠出来作为子网号，用剩余的 n-k bit作为主机号，这样就能划分出 $2^k$个子网（每个子网包含的IP地址块大小相等）

- 子网划分前，IP地址为两级结构=<网络号，主机号>
- 子网划分后，IP地址为三级结构=<网络号，子网号，主机号>
- 每个子网地址中，主机号不能分配为全0/全1，全0表示子网本身，全1为子网广播地址

#### 2.3.2 子网掩码

- 作用
	- 用子网掩码、IP地址"逐位与"，算出<网络号,子网号>（可合称为“网络前缀"）
	- 只有网络前缀相同的IP地址，才归属于同一个网络（或子网）
- 注意
	- 如果一个网络内部进行了子网划分，那么这个网络中的每台主机、每个路由器接口都需要配置IP地址、默认网关、子网掩码
	- 如果一台路由器支持子网划分技术，那么在它的转发表中，需要包含<目的网络号，子网掩码，转发接口>

#### 2.3.3 默认子网掩码

如果一个传统网络（A/B/C类）内部没有进行子网划分，那么可以将对应此网络的转发表项设置为“默认子网掩码”

|    A类     |     B类      |      C类       |
| :-------: | :---------: | :-----------: |
| 255.0.0.0 | 255.255.0.0 | 255.255.255.0 |

#### 2.3.4 默认路由

- 默认路由（默认转发表项）设置：<目的网络号全0，子网码全0>
- 在路由器转发表中，如果所有表项都不匹配，那么将从“默认路由”转发出去

#### 2.3.5 主机发送IP数据报的过程

1. **判断目的主机和本机是否属于同一个网络**
	- 检查本机IP地址和目的IP地址的网络前缀是否相同（需要用本机配置的子网掩码“逐位与”）。
	- 若网络前缀相同，说明目的主机和本机属于同一个网络；若网络前缀不同，说明不属于同一网络。
2. **将IP数据报封装成MAC帧并发送到链路上**
	- 如果目的主机与本机属于同一个网络，就通过ARP协议找到目的主机的MAC地址，再将IP数据报封装成帧，并将帧发送给目的主机。
	- 如果目的主机与本机不属于同一个网络，就通过ARP协议找到默认网关的MAC地址，再将IP数据报封装成帧，并将帧发送给默认网关。

#### 2.3.6 路由器转发IP数据报的过程

1. **接收IP数据报**
	-  路由器的某个接口收到一个IP数据报。
2. **校验和目的IP地址提取**
	- 对IP数据报首部进行校验，并从中找到目的IP地址。
3. **查转发表**
	- 转发表的表项包含<目的网络号，子网掩码，转发接口>。
	- 检查目的IP地址与每个表项能否匹配（将目的IP地址、子网掩码“逐位与”，匹配表项中的目的网络号）。
	- 注：
		1. 至少“默认路由”表项一定是可以匹配成功的。
		2. 采用 CIDR 技术后由于路由聚合一个IP地址在转发表中可能会匹配多个表项，此时应使用最长前缀匹配原则。
4. **转发IP数据报**
	- 根据查转发表的结果，将IP数据报从匹配的接口转发出去。
	- 注：如果匹配的“转发接口”和该IP数据报的入口相同，就不用再把IP数据报转发回去。

### 2.4 无分类编址CIDR

#### 2.4.1 背景
   - 取消了IP地址传统的A/B/C/D/E分类。
   - 采用无分类编址CIDR，IP地址块分配更灵活，利用率更高，一定程度上缓解了IP地址耗尽（时代背景：1993年）。

#### 2.4.2 基本原理
   - IP地址 = {<网络前缀>,<主机号>}，其中网络前缀不定长。
   - CIDR记法 ——128.14.32.153/30，表示在这个IP地址中，网络前缀占30bit，主机号2bit。

#### 2.4.3 CIDR地址块的子网划分
   - **定长子网划分**：在一个CIDR地址块中，把主机号前$k$bit 报出来作为定长子网号，这样就能划分出$2^k$个子网（每个子网包含的IP地址块大小相等）。
   - **变长子网划分**：在一个CIDR地址块中，划分子网时，子网号长度不固定（每个子网包含的IP地址块大小不同）。
   - 注意：在每个子网中，主机号全0、全1的IP地址不能分配给特定节点私用。

#### 2.4.4 子网划分解题技巧
   - 可以利用类似于“从根到叶构造二叉哈夫曼树”的技巧。
     - 原始CIDR地址块作为根节点（假设可以自由分配的主机号占 $h$ bit）。
     - 每个分支节点必须同时拥有左右孩子，左0、右1（反过来也行）。
     - 每个叶子结点对应一个子网，根据根节点到达叶子结点的路径来分析子网对应的IP地址块范围。
     - 整棵树的高度不能超过h-1（因为即使最小的子网即点对点链路至少要保留$2$bit 主机号）。


### 2.5 路由聚合（构成超网）
#### 2.5.1 路由聚合的原理

![](attachment/路由聚合.png)

4. **原理**：对于一个路由转发表，如果几条路由表项的转发接口相同， 部分网络前缀也相同，那么可以将这几条路由表项聚合为一条。
5. **优点**：路由表更小，查询更快
6. **缺点**：可能会引入无效地址

#### 2.5.2 最长匹配原理

路由器在转发数据包时，从路由表中选择与目标IP地址匹配最长的前缀（即最具体的路由）进行转发。

### 2.6 NAT网络地址转换

#### 2.6.1 私有IP地址（内网IP）
   - **范围**:
     - 10.0.0.0～10.255.255.255
     - 172.16.0.0～172.31.255.255
     - 192.168.0.0～192.168.255.255
   - **用途**:
     - 只允许分配给局域网内部的节点，不允许分配给互联网上的节点。
     - 每个局域网内部都可以自行分配这些私有IP地址。
     - 私有IP地址是可复用的，只要求局域网内唯一，不要求全球唯一。

#### 2.6.2 全球IP地址（外网IP）
   - 通常由ISP提供，全球唯一。
   - 外网IP是一个局域网与外界通信时所需使用的IP地址。

#### 2.6.3 网络地址转换（NAT）
   - **作用**: 转发IP数据报时，进行内网IP、外网IP的相互转换。
   - **NAT表**: 记录地址转换关系，格式为内网IP:端口号@外网IP:端口号。
   - **NAT路由器**:
     - 从内网转发到外网，会更改源IP地址、源端口号。
     - 从外网转发到内网，会更改目的IP地址、目的端口号。
     - NAT路由器包含传输层的功能（因为端口号是传输层的概念）。
- 与普通路由器的区别
	   - 普通路由器转发IP数据报时，不会改变源IP、目的IP地址。
	   - 普通路由器仅包含网络层及以下的功能。

### 2.7 地址解析协议（ARP）

#### 2.7.1 回顾MAC地址
   - MAC地址（48bit）是网络适配器出厂时分配好的，全球唯一。
   - 一台主机至少有一个网络适配器（网络插口背后的芯片），因此主机至少有一个MAC地址。
   - 一台路由器有多个转发接口，每个接口背后都是一个网络适配器，因此路由器有多个MAC地址。

#### 2.7.2 ARP的作用
   - 在一个局域网内部，可以通过ARP协议查询到一个IP地址对应的MAC地址。

#### 2.7.3 ARP表（ARP缓存）
   - 记录（IP地址, MAC地址）之间的映射关系。
   - 一个数据结构（每台主机、每台路由器都有自己的ARP表）。
   - 需要定期更新ARP表项。

#### 2.7.4 ARP过程
1. **ARP请求分组**:
     - 内容：
	     1. 我是谁？：我的IP地址是X，我的MAC地址是Y。
	     2. 我想找谁？：我想找的这个家伙，IP地址是Z。
     - ARP请求分组封装进MAC帧（帧目的地址=全1，源地址=Y）（==广播帧==）
 2. **ARP响应分组**:
     - 内容：你好，我就是你要找的那个人，我的IP地址是Z，我的MAC地址是V。
     - ARP响应分组封装进MAC帧（帧目的地址=Y，源地址=V）（==单播帧==）

### 2.8 动态主机配置协议（DHCP）

#### 2.8.1 基本概念

- **DHCP协议的作用**:
	- 给刚接入网络的主机动态分配IP地址
	- 配置默认网关、子网掩码

- **DHCP使用客户/服务器模型 (C/S)**:
	- **DHCP客户**
	    - 就是新接入网络的主机（希望获得IP地址等配置）
	- **DHCP服务器**
	    - 就是负责分配IP地址的那台主机，管理一系列IP地址池
	    - 注：在家庭网络中，通常由家庭路由器兼职“DHCP服务器”
	    - 在一个大型网络内可以有多台DHCP服务器

- **DHCP是应用层协议，基于UDP**:
	- 客户UDP端口号=$68$
	- 服务器UDP端口号=$67$

#### 2.8.2 DHCP协议运行的过程

```mermaid
sequenceDiagram
    participant Client
    participant Server

    %% 交互步骤
    Client->>Server: DISCOVER①
    Note left of Client: ①找DHCP服务器
    Server->>Client: OFFER②
    Note right of Server: ②DHCP服务器给客户端IP地址
    Client->>Server: REQUEST③
    Note left of Client: ③客户端确认收到IP地址，但还不使用
    Server->>Client: ACKNOWLEDGE④
    Note right of Server: ④DHCP服务器确认客户端使用这个地址

    %% 隐藏默认序号
    autonumber off
```

##### I. 客户端→服务器：DHCP发现报文
- 携带信息：客户主机的MAC地址（还可以提出对IP地址租用期的要求）
- 网络层：源IP地址=$0.0.0.0$，目的IP地址=$255.255.255.255$（广播IP数据报）
- 链路层：源MAC=客户的MAC地址，目的MAC=全1（广播帧）

##### II. 客户端→服务器：DHCP提供报文
- 携带信息：给客户分配的IP地址、租用期、子网掩码、默认网关
- 网络层：源IP=DHCP服务器的IP地址，目的IP=$255.255.255.255$（广播IP数据报）
- 链路层：源MAC=服务器的MAC地址，目的MAC=客户的MAC地址（单播帧）

##### III. 客户端→服务器：DHCP请求报文
- 携带信息：客户机确认要使用的IP地址
- 网络层：源IP=$0.0.0.0$，目的IP=$255.255.255.255$（广播IP数据报）
- 链路层：源MAC=客户的MAC地址，目的MAC=全1（广播帧）

##### IV. 客户端→服务器：DHCP确认报文
- 携带信息：与报文②类似
- 网络层：源IP=DHCP服务器的IP地址，目的IP=$255.255.255.255$（广播IP数据报）
- 链路层：源MAC=服务器的MAC地址，目的MAC=客户的MAC地址（单播帧）



## 3 IPv6

### 3.1 为什么有IPv6

- 应为CIDR和NAT治标不治本，IPv6在根本上解决问题
	- 改进了首部格式
	- 快速处理/转发数据报
	- 支持QoS

### 3.2 IPv6数据报格式

1. IPv6的基本首部（40B）
	
	1. **版本 (Version)** - 4位
	   - 指定IP协议版本，对于IPv6该值为6。

	2. **通信量类别 (Traffic Class)（优先级）** - 8位
	   - 类似于IPv4的服务类型（TOS），用于区分不同优先级的数据流，支持QoS（Quality of Service）。

	3. **流标签 (Flow Label)** - 20位
	   - 标识特定流的数据报，有助于路由器识别需要特殊处理的数据流，比如那些要求特定服务质量或实时服务的数据流。

	4. **有效载荷长度 (Payload Length)** - 16位
	   - 表示紧随基本报头之后的数据部分的总长度，包括所有扩展报头和上层协议数据单元。最大值为65535字节。

	5. **下一个首部 (Next Header)** - 8位
	   - 指示紧跟在基本报头之后的头部类型。它可以是一个扩展报头或上层协议（如TCP、UDP）。

	6. **跳限制 (Hop Limit)** - 8位
	   - 类似于IPv4的TTL（Time To Live），每经过一个路由器该值减1，当其变为0时，数据包将被丢弃。

	7. **源地址 (Source Address)** - 128位
	   - 发送者的IP地址。

	8. **目的地址 (Destination Address)** - 128位
	   - 接收者的IP地址。
2.  IPv6的有效载荷（至64KB）

```mermaid
flowchart TD
    subgraph 整体结构["IPv6数据报格式"]
        direction TB
        首部["IPv6的基本首部40B"] --> 载荷["IPv6的有效载荷（至64KB）"]
    end

    subgraph 首部["IPv6的基本首部40B"]
        direction LR
        A[版本 4bit] --> B[优先级 8bit] --> C[流标签 20bit]
        D[有效载荷长度 16bit] --> E[下一个首部 8bit] --> F[跳数限制 8bit]
        G[源地址 128bit]
        H[目标地址 128bit]
    end

    subgraph 载荷["IPv6的有效载荷（至64KB）"]
        I[扩展首部/数据]
    end
```


### 3.3 IPv4和IPv6的不同


1. IPv6将地址从32位 (4B) 扩展到**128位 (16B)**，更大的地址空间。
2. IPv6将IPv4的校验和字段彻底移除，以减少每跳的处理时间。
3. IPv6将IPv4的可选字段移出首部，变成了**扩展首部**，成为灵活的首部格式，路由器通常不对扩展首部进行检查，大大提高了路由器的处理效率。
4. IPv6支持**即插即用**（即自动配置），不需要DHCP协议。
5. IPv6首部长度必须是**8B的整数倍**，IPv4首部是4B的整数倍。
6. IPv6**只能在主机处分片**，IPv4可以在路由器和主机处分片。
7. ICMPv6：附加报文类型“分组过大”。
8. IPv6支持资源的预分配，支持实时视像等要求，保证一定的带宽和时延的应用。
9. IPv6取消了协议字段，改成下一个首部字段。
10. IPv6取消了总长度字段，改用有效载荷长度字段。
11. IPv6取消了服务类型字段。



### 3.4 IPv6的地址表现形式


1. IPv6地址的一般形式
	- IPv6地址由$8$组$16$位（即$4$个十六进制数字）组成，每组之间用冒号分隔。
	- 示例：`2001:0db8:85a3:0000:0000:8a2e:0370:7334`

2. IPv6地址的压缩形式
	- 连续的全零组可以用双冒号`::`表示，但一个IPv6地址中只能出现一次双冒号。
		- 示例：
		    - 原始地址：`2001:0db8:85a3:0000:0000:8a2e:0370:7334`
		    - 压缩后：`2001:db8:85a3::8a2e:370:7334`
	- 注意：如果存在多个连续的全零组，双冒号只能使用一次。如果有多个位置可以应用双冒号，则选择最左边的一个。 
		- 另一示例：
			- 原始地址：`2001:0000:0000:0000:0000:0000:1428:57ab`
			- 压缩后：`2001::1428:57ab`


### 3.5 IPv6的基本地址类型


1. **单播**
   - 一对一通信
   - 可做源地址+目的地址

2. **多播**
   - 一对多通信
   - 可做目的地址

3. **任播**
   - 一对多中的一个通信
   - 可做目的地址


### 3.6 IPv4向IPv6的过渡

1.	双栈协议
	- 允许设备同时支持IPv4和IPv6
	- 设备可以拥有一个IPv4地址和一个或多个IPv6地址
	- 优先尝试通过IPv6通信，若不可行则回退到IPv4

2.	隧道技术
	- 在IPv4网络中传输IPv6数据包（或反之）
	- 主要用于连接被IPv4网络分隔开的IPv6网络
	- 需要在两端配置适当的接口来**封装和解封装数据包**

## 4 路由协议
### 4.1 自治系统


### 4.2 域内路由与域间路由




### 4.3 RIP路由协议




### 4.4 OSPF路由协议




### 4.5 BGP路由协议




## 5 IP 多播




### 5.1 多播的概念




### 5.2 IP 多播地址




## 6 移动 IP




### 6.1 移动 IP 的概念




### 6.2 移动 IP 通信过程




## 7 网络层设备




### 7.1 路由器的组成和功能




### 7.2 路由表与路由转发



