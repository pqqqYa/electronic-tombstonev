# 传输层

## 1 传输层和网络层的对比

### 1.1 网络层
网络层实现了“主机到主机”的通信。网络层在IP数据报的首部，指明源IP地址、目的IP地址。

### 1.2 传输层
传输层实现了“端到端”（进程到进程）的通信。传输层在 $\mathsf{TCP}$ (或 $\mathsf{UDP}$) 报文段的首部，指明源端口、目的端口。

## 2 端口

### 2.1 端口的作用
1. 通过“端口号”标识本主机的一个特定进程
	- 注意：每台主机的端口号是相互独立的
	- 注意：TCP、UDP两种协议的端口号是相互独立的
2. TCP或UDP协议，通过Socket套接字=$\{IP地址：端口号\}$，唯一地标识网络中的一台主机上的一个应用进程
	- 分为UDP嵌套字和TCP嵌套字
### 2.2 端口号的分类
- 服务器使用的端口号
	- 熟知端口号 0~1023 —— 通常只能用于被熟知的重要应用程序
	- 登记端口号 1024~49151
- 客户端使用的端口号
- 短暂端口号 49152~65535

| 应用程序  | FTP | TELNET | SMTP | DNS | TFTP | HTTP | SNMP |
| ----- | --- | ------ | ---- | --- | ---- | ---- | ---- |
| 熟知端口号 | 21  | 23     | 25   | 53  | 69   | 80   | 161  |

## 3 传输层的作用

1. 实现端到端（进程到进程）的通信

2. 复用和分用
	- 复用（从上到下）：在发送数据的时候，同一台主机上的多个进程可以使用同一个传输层协议
	- 分用（从下到上）：在接收数据的时候，传输层可以把数据正确交付到目的进程

3. 差错检测
	- TCP检测出差错后丢弃数据，并通知发送方重传
	- UDP检测出错误后直接丢弃数据，且不通知发送方

4. 向应用层提供两种服务
  - 面向连接的、可靠的端到端传输服务（TCP）—— 确保数据正确/完整，但开销大、实时性较差
  - 无连接的、不可靠的端到端传输服务（UDP）—— 数据可能出错/丢失，但速度快、开销小

## 4 UDP协议

### 4.1 UDP协议与TCP的特点对比

#### 4.1.1 UDP协议特点
- UDP首部很小，只占8B
- UDP每次传输一个完整的报文，不支持报文自动拆分、重装
- UDP是无连接的、不可靠的（可靠性可以交给应用层处理），也不支持拥塞控制
- UDP支持一对一（封装成单播IP数据报）、一对多传输（封装成广播/多播IP数据报）

#### 4.1.2 TCP协议特点
- TCP首部更大，占20~60B
- TCP支持报文自动拆分、重装，因此可以传输长报文
- TCP是有连接的、可靠的、支持拥塞控制
- TCP仅支持一对一传输（因为通信双方的传输层必须先建立连接）


### UDP数据报

![](attachment/UDP数据报格式.png)

### 首部

首部固定长度为8B，即64bit

1. **16位源端口号**：发送进程的端口号，如果不需要对方回复可以设置全为0
2. **16位目的端口号**：接收进程的端口号（必填）
3. **16位UDP长度**: UDP数据报（包括首部和数据）的总长度
	- 以字节Byte为单位
	- UDP数据报的理论最大长度=65535Byte
4. **16位UDP检验和**: 由发送方的传输层计算并填入校验和，接收方的传输层检测是否有差错。（如果无需校验，可以填入全0)

### 数据
- **数据**：一个完整的应用层报文


### UDP检验