# 0. 术语表

**区块链**

字面意思理解区块链，区块链是指由一个一个包含数据的区块按照顺序连在一起的一条链。深入理解的话，区块链是借由密码学串接并保护内容的串连交易记录（又称区块）。

每一个区块包含了前一个区块的加密散列、相应时间戳记以及交易数据（通常用默克尔树算法计算的散列值表示），这样的设计使得区块内容具有难以篡改的特性。用区块链所串接的分布式账本能让两方有效纪录交易，且可永久查验此交易。

**区块链共识**

Consensus，通过密码学让分布式网络达成一致的一种算范，如PoW，PoS，DPoS

**PoW**

Proof of Work，工作量证明机制

**PoS**

Proof of Stake，股权证明机制

**Coin**

区块链网络中的基础货币，具有网络内交易、转账等基础功能。它是一种原生币，通常由网络上的矿工通过挖矿产生，并伴随着交易产生手续费。是区块链网络的基础为整个网络提供基本的交易和转账功能。

**Token**

区块链技术的一种可流通的数字资产，它可以代表各种权益、资产或服务的所有权，是基于Coin之上的附加价值。Token可以通过智能合约来发行，其具体规则由相应的项目方制定。

**Stake**

可以翻译为动词质押，在PoS共识中，通过Stake可以获得出块人权利，将Token进行Stake，意思就将Token抵押给系统的意思。


**硬分叉与软分叉**


软件的更新不向后做兼容。比如2013版本的word文件在2018版本的word里面是可以打开的，这种更新是做了向后兼容的，可以理解为是软分叉；如果不能打开，可以理解这个更新是一次硬分叉。

  

**最终确定性**


指区块信息无法被篡改，或者篡改可能性非常小


**Dapp**

去中心化应用，Decentralized Applications

  

**TPS**


每秒交易笔数（Transactions per second）

  

**Nothing at Stake**

  

无利害关系，指在PoS共识下，验证人作恶无风险的行为情况

  

**Slash**


削减/扣除，指PoS共识下，系统扣除验证人抵押金的行为


**矿工/验证人/出块人**


* 矿工：PoW共识中的节点维护人
* 验证人：PoS共识中的节点维护人，有些项目也叫出块人（Block Producer）

  

**ICO**

Initial Coin Offering 首次币发行

  

**Voting Power**

直译为投票权重，实际指的是通过Stake的代币占总量的比重。比如代币总量为1亿，1千万代币进行了Stake，那么整体的投票权重为10%，这10%可能分布在不同节点身上，和节点数量没有关系，很可能是5%分布在一个节点，其余5%分布在生态中其他100个节点中。


**Nonce**

在通信安全中，Nonce是一个在加密通信只能使用一次的数字

# 1. PoS介绍

  

## 1.1 什么是区块链共识


区块链是由一个一个块链接形成了块链条，每个新块生成（包含交易记录）都需要参与验证人的共同确认，这个共同确认的过程就是区块链共识。

主流的共识算法包括PoW（Proof of Work工作量证明），PoS（Proof of Stake 股权证明机制），BFT （拜占庭容错机制），Pool验证池，混合共识等，还有一些从主流基础上演变出来的共识算法，诸如PoA（Proof of Authorization授权证明机制），PoI（Proof of Importance重要性证明机制），DPoS （Delegate Proof of Stake股权证明机制），PBFT（Practical Byzantine Fault Tolerance使用拜占庭容错算法）等等。

## 1.2 什么是PoW-工作量证明

工作量证明是比特币等许多区块链网络所采用的共识算法。它的核心思想是要求矿工通过解决复杂的数学问题，来验证交易并将新区块添加到链中。解决这个问题的过程需要大量的计算能力，因此得名“工作量证明”。

PoW的工作原理是：每个节点通过执行哈希运算来争夺区块链上的下一个区块的记账权。哈希函数的特点是输入稍有变化，输出就会有很大的不同，这使得攻击者难以伪造。当节点找到一个满足特定条件的哈希值时，它就拥有了本次记账权，可以发布本轮需要记录的数据，其他节点验证后一起存储。

PoW的安全性在于其计算的困难性。哈希函数的特性使得计算出一个满足条件的哈希值非常耗时，而且随着计算能力的提升，难度也会随之增加。这意味着攻击者需要控制大量的计算能力才能发起攻击，这被称为51%攻击。然而，在实际操作中，攻击者要达到这个门槛非常困难，因此PoW被认为是一种相对安全可靠的共识算法。

PoW也存在一些缺点。最明显的是其能源消耗问题。由于计算哈希值需要大量的能源，以以太坊为例，在从PoW转向PoS后根据第三方的统计能源消耗较少超过99%，因此有人批评PoW对环境造成负面影响，也是因为这个原因PoW算法的区块链的挖矿行为在中国大陆现行法律中属于违法行为。此外，PoW还面临着可扩展性和公平性问题。由于每个节点都需要进行哈希运算，交易确认时间较长且难以提高交易效率，而且只有拥有足够计算能力的节点才能参与挖矿，这引发了对于资源公平分配的质疑。


## 1.3 **什么是PoS-股权证明机制共识**

  
权益证明是一种改进的共识算法，旨在解决PoW所面临的一些问题。与PoW不同，PoS不再依赖计算能力来争夺记账权，而是根据每个节点所占有的代币数量和时间来决定挖矿难度和权益。随着时间的推移，拥有更多代币的节点将有更大的机会成为下一个区块的验证者。

PoS的优点在于其能源效率更高。由于不再需要大量的计算能力来争夺记账权，能源消耗大大减少。此外，PoS还提高了可扩展性和公平性。由于验证者是根据其所占有的代币数量和时间来选择的，因此资源更加公平地分配给了所有节点。同时，由于减少了必要的手续和时间消耗,PoS也提高了交易的效率。


PoS共识中引入了Stake的概念，持币人将代币进行Staking，然后获得出块的机会，PoS共识中会通过选举算法，按照持币量比例，选出区块的矿工。矿工在指定区块高度（BlockHeight，区块的标号，本个区块与创世区块之间的块数）完成打包交易，生成新区块，并广播区块，广播的区块经过PoS共识中另外一道门槛，验证人，验证交易，通过验证后，区块得到确认。这样一轮PoS的共识过程就进行完成了。



# 2. PoS的发展

## 2.1 PoW+PoS

混合PoW+PoS共识是PoW过渡到PoS的一种过渡阶段。

## 2.2 纯PoS

纯PoS有更短的区块间隔，更合理的铸币方式，从而吸引了很多早期的人进来挖矿，甚至有很多专门做矿池的开始在论坛收币做验证人（Validator）。但是早期的PoS机制币种的案例也不少，原因大多在与PoS中Staking的激励太小，无法支持验证人的成本，还有就是去中心化的运行模式在PoS上的应用并不想PoW上那么完善。

## 2.3  委托PoS（DPoS）

比特股BitShares采用的区块链共识算法是权益授权证明Delegated Proof of Stake（简称DPoS），基于石墨烯（Graphene）平台搭建，这套石墨烯技术后来发展成了DPoS的专用底层，基于石墨烯开发的区块链项目可以直接使用DPoS的共识机制，免去了重复开发的苦恼，像Steemit，EOS，Lisk等都是基于石墨烯平台搭建的DPoS公链。

Graphene 是一个使用 DPOS 达成共识的区块链框架，但是对于现阶段来说，石墨烯区块链已经过时了。

## 2.4 BFT+PoS

拜占庭容错（Byzantine Fault Tolerance，简称BFT ）和PoS结合最早是在2014年由Tendermint团队提出。而Tendermint前身，则是基于1988年在麻省理工学院开发的经过验证的BFT算法（PBFT）。基于Tendermin的第一个项目是Cosmos项目。

BFT容错能给分布式网络带来了可观的抗风险能力，还能带来了较快的区块确认速度，解决区块链分叉问题，并带来一定程度的交易的最终确定性，间接的提高了性能。如果说纯PoS比起纯PoW，仅仅是解决了能源消耗，那么BFT+PoS比起纯PoS，那就是除了解决能源消耗外，还解决了PoW的交易确认，交易分叉，性能较低等问题。

Tendermint中很重要的一部分就是它的共识引擎部分（Tendermint Core），该共识引擎将BFT和PoS共识结合到了一起，持币人通过stake获得验证区块机会，签名完成后，新区块的验证通过3轮提交，2轮2/3的投票过程，来达成最终共识。由于投票是在区块广播后就开始的，那么当它完成了验证之后，新区块即获得了及时确定性（Instant Finality），这和比特币交易需要6个区块确认不一样，Tendermint大大缩短了验证时间，使得交易能及时生效，提前避免了交易被回滚，双花等问题的出现。

同时拜占庭容错最大能容忍系统中小于1/3的验证权重宕机，能很好的保证系统运行，可以简单理解为，只要系统中大部分人是诚实的，不管其他验证人怎么做，系统还能运行，不会出现停止，宕机的情况。

## 2.5 新一代PoS

Algorand专注于新的PoS+BFT共识算法（简称BA，Byzantine Agreement），旨在让验证人的选举更加随机，不可预测，以更好的保证系统的安全为研究方向

Thunderella旨在解决PoS当中的性能扩展问题

# 3. PoS的运行原理

PoS共识的运行有7个基本步骤
1. 运行节点
2. 注册成验证人
3. Stake
4. 选举验证人
5. 打包交易
6. 广播交易
7. 验证人确认

## 3.1 运行结点

区块链分布式账簿中的一个点，这个点（也就是运行节点的电脑），存储着区块链所有的交易记录即全结点运行（或相邻的部分节点的交易记录），并将参与到整个网络的共识当中去。所以电脑即充当了存储的功能，也充当着计算的功能。

在钱包配置完成后即可参与到PoS共识，即PoS挖矿中。按照不同的共识可以将拥有的挖矿权益委托给专业矿工，就可以参与到共识挖矿中去。

钱包（DeFi Wallet，Blockchain Wallet）由该项目所创立的加密货币交易所提供的去中心化金融钱包服务的名称。钱包允许通过去中心化交易所管理、交易、交换和使用加密货币。

初期的PoS项目基本都是全节点钱包客户端，其模拟的也是比特币初期可用电脑CPU挖矿的原理，运行节点的门槛也就是需要一台计算机。但全节点的缺点在于，随着区块数据的增多，会需要更多存储空间。同时，钱包客户端不能掉线，也就是不能关机，断网或者断电，要不然你无法运行节点来获得出块机会，已获得的出块机会在此种情况下也无法继续。

在这种情况下就发展出了矿池（[Mining Pool](https://www.investopedia.com/terms/m/mining-pool.asp#:~:text=A%20mining%20pool%20is%20a,network%20is%20trying%20to%20solve.)）这种专业挖矿的机构，可以支持24小时，不断电，不停网的挖矿方式，普通用户如果不想自己守着电脑挖矿，可以将币发送给矿池，让矿池来帮助自己出块获得奖励。矿池通过收取一定的手续费来获得收入。，但是这种委托需要把币给到矿池手中，用户往往需要承担很大的风险，如果矿池失窃，或是卷款潜逃，用户往往一点办法都没有，需要极大的信任，还需要矿池维护人员有良好的职业操守。

另一种委托方式则是委托只是建立一种关系，而不需转移代币。用户发起委托，委托期间，但是仍然能支配自己的代币，极大的降低了非自愿运行节点用户Staking的成本。

## 3.2 声明为验证人

首先需要保证的就是验证人节点的配置符合项目的要求，验证人的配置要求要比全节点的配置要求要高。其次确认项目对验证人节点的一些硬性门槛，如持币量，锁定时间等。除了硬性要求，还有一些软性实力的要求，比如验证人需要时团队，或者公司，要求不能用云服务器，要求在社区有一定的声誉，要求投票需要达到一定的数量等等。

## 3.3 质押Stake

成为验证人之后，该验证人账户中的币会被检测，带有门槛的PoS共识会在此检测一些条件，当条件符合时，账户被标识为合格，然后放到验证人列表当中。如果不合格，此验证人并不会在真正的验证人列表里面。合格的验证人，其账户里面所有的币都是质押成为Staking的币，系统会计算该账户的Staking数量在总体Staking量中的占比，使用算法来选举每个区块的验证人。

但在一些项目中没有Stake的操作命令，只需要申请成为验证人的账号有代币，成为验证人之后，该账户的币就相当于默认Stake了。

## 3.4 选举验证人

系统会从候选的验证人列表当中选择出块人。选择出块人的算法有很多种，每种的优缺点都不一样，但是它们都有一个共同要保证的任务，那就是保证选举结果不能被操纵，不能被预测，防止Grind Attack的攻击发生。只有安全性足够高的算法，才能保证整个token的激励系统不会被单一方所控制。

以下列举几种目前比较流行的选举方式：

### Follow-the-Satoshi

Follow-the-Satoshi算法，最早出现在论文《[Proof of Activity: Extending Bitcoin's Proof](https://eprint.iacr.org/2014/452.pdf)》中，其作用就是在PoA（Proof of Activity）共识当中选出出块人。

Satoshi这里的意思是聪，是比特币电子货币形式里，最小的计数单位，每个已被铸造出来的聪都对应一个UTXO（未经花费的输出--Unspent Transaction Output），而每个UTXO都可以对应到一个私钥，而每一个私钥都可以对应到一个持有人。如果用持币权重（Voting Power）代替算力权重的话，PoS共识中的持币人其权重，其实就是多个聪的集合，所以选择出块人，即从这些聪的集合当中选择就可以了，哪个持有人中拥有最多被选中的聪，那他就是这个高度的出块人。这就是Follow-the-Satoshi的原理。

PoS中的持币人staking后，可以被最小单位s划分成很多份，Follow-the-Satoshi当中会有一个随机数输入源p，充当最开始的随机起始点，然后随机选出这个出块人。每个持币人都有多份s，那么单个块的出块人就是当前包含最多p的持币人。

运用Follow-the-Satoshi算法的PoS项目有Tezos和Cardano。

Tezos对算法做了改良，因为聪的单位太小，随着系统锻造出来的聪越来越多，选择算法会变得低效，所以Tezos进行了规整，以10000XTZ为一个卷（Roll），将卷作为随机数选择的目标，以此来提高选择效率，包含选中最多的卷将成为块的出块人。同时，为了让随机数源变得不可预测，Tezos将4096个块当成一个选举周期（Cycle），利用上一个周期出块人披露的Nonce（在通信安全中，Nonce是一个在加密通信只能使用一次的数字）为随机数输入源。未披露的验证人将会被扣除抵押金。

Cardano的做法和Tezos类似，以一定区块数为选举周期（Epoch），每个周期有一个创世块，每个创世块中包含了每个块的出块人和一个随机种子p。和Tezos不同的是，Cardano每个块只有一个出块人，如果这个出块人掉线，这个块会被抛弃，直接进入下一个区块。而Tezos中单个块会有多个出块人，这些出块人会有不同的优先级，以避免备选出块人出现的种种情况。

### Round Robin

维基百科对Round Robin的解释是：

术语循环/轮转/轮替（英语：Round-robin）用于多种情况中，通常指将多个某物轮流用于某事，例如"逐户派对"（round-robin-party）中所有参与者要挨家挨户地拜访每位参与者的住处并参加那里的小型聚会。联名信（round-robin letter）往往是指一大群下属为批评其领导而写的一封信，这种信一般只在签名人数多到难于逐个报复后才会寄出。

一个简单的Round Robin算法的例子如：F(i, b) = 1 if b.height % N == i else 0

RR（Round Robin）常用于联盟链或者私有链居多，因为循环出块的可预知性太强，如果在一个可允许被随意进入（Pemissionless）的区块链网络里面，被攻击的概率会比较大，系统抗风险性变差。所以，在联盟链或者私有链的网络里面，各个节点互相知道/审核/同意（Pemission），利用RR既是一种简单可行的方式，又是一种高效的算法。

但是，后来有项目方改良了RR的算法，用于到Pemissionless的区块链网络中来确定出块人。我不确定是否是EXONUM团队对RR进行了首次改良，但是我在google找到到了他们改良的[方案](https://exonum.com/blog/04-28-17-leader-election-roundrobin/ "https://exonum.com/blog/04-28-17-leader-election-roundrobin/")。相对的，在Multichain的[白皮书](https://www.multichain.com/download/MultiChain-White-Paper.pdf "https://www.multichain.com/download/MultiChain-White-Paper.pdf")中也有将RR算法运用到联盟链中的说明。

在EXONUM里面，RR的执行逻辑是，在一个高度H里面，所有出块人排列成一定的顺序（优先级），如果首位出块人掉线则直接跳过，第二位出块人代替首位出块人位置来出块，如果第二位出块人掉线，则排在第三位的出块人顶上，以此类推，由此得出循环算法的说法。在高度H+1里面，在H高度的出块人将不在获得出块机会，其出块权利会被锁定一定的周期F，只有等权利解锁后才会再次被加入的排序中来。

当然，每个高度H的出块人排序不能是固定的，那么会被攻击者找到攻击目标。所以每个高度H的顺序由算法得出，T = Hash(H) mod M!。可以确定每轮（Round），验证人的排序都不一样，这样就避免了相同顺序下，验证人合谋的低成本问题。

Cosmos同样使用了RR算法来进行验证人选举。Cosmos按照出块人的权重（Voting Power），来确定高度H下的出块人（Proposer），每个高度的第一个Proposer对出块进行提议，然后进入该高度H的第一个Round，其他验证人对该提议进行两轮投票（Prevote和Precommit），两轮都超过2/3通过，该区块被commit，成为高度为H+1的块。如果中间的任意议论投票中，有一轮的投票并没有达到2/3的权重（Voting Power），那么第一个Proposer的提议被否决，这进入第二个Proposer的提议阶段，提议重复第一个Proposer提议的流程，以此类推。

在写此书的时候，Cosmos的测试跑到了Gaia9003，Genki4002，同时还进行着一个主网上线前的测试网网络Game of Stake，对于测试网中的很多功能还在测试，包括验证人选举，所以对于RR的算法并不是最终版本，等到主网上线后，我会再来补充具体的选举出块人方式。

### DPoS

DPoS是由Daniel Lamier在2013年的比特股（Bitshares）上提出来的，其底层是基于石墨烯平台来搭建，我在此处说明的是基于石墨烯底层搭建的DPoS系统，其他的委托权益证明共识Delegate-PoS不在此范围之内。

基于石墨烯的DPoS，其出块人选举和RR算法有点像，更像是简单版本的RR。在DPoS的系统中，所有出块人由用户投票得出，投票最高的几位出块人获得出块机会。通常，出块人的数量是固定的，如EOS里面固定是21位，这21位出块人被投票出来之后，在一轮（126个块，每个出块人6个块）中，其出块顺序由15个及以上的生产者约定的顺序安排。

目前EOS的约定顺序是按照字母a-z排列的，比如Asia会比Basic排在前面出块，而Canada会在Basic后面出块。目前的这种排序方式，决定了每轮的排序其实有一样的顺序。

所以DPoS里面一个很基础的选举方式就是，系统规定一个固定数量的出块人，出块人由持币人投票得出，投票率按照高到低排序，系统按照高到低选择指定数量的出块人，然后将出块人随机排序，随机源可能是时间戳，也可以能出块人之间随机的参数。

### MPC多方计算（multiparty computation）

多方计算是由Cardano提出来的，目的是保证选举算法中的无偏差性，?通过计算获得一个随机数，作为选举算法的输入。随机源计算出来后，选举算法仍然使用的是3.4.1 follow the satoshi的方法。为了避免重复，我们这里说一下MPC。

在Cardano的文档中，对多方计算有以下的解释：

多方计算（multiparty computation (MPC) ）方法用来实现选举的随机性，每个参选人独立进行一次『投硬币』的行为，然后与其他参选人分享结果。这个想法就是：结果由每个参选人随机产生，但最终它们在相同的最终价值上达成一致。

Cadano使用的是类似于扔硬币的方案来决定区块人，分为3个阶段。提交，开启和恢复阶段。在提交阶段，参选人通过私钥签名一个提交，并附上周期标号，公钥等信息，这个提交会被广播给其他参选人，每个参选人都可以拿到其他参选人的提交。

在开启阶段，参选人提交一个开启状态，这个状态带着一个值，可以解开第一步提交的数据。同样，每个人都可以拿到其他人的开启值。

最后恢复阶段，每个参选人相当于都拿到了所有的提交和开启，如果参选人中存在不诚实的人，那么很有可能有些不提交，或者不提交开启的情况出现，在这种情况下，诚实的选民可以张贴（上面有提到）来重建密钥，这个想法很简单：即使某些选民是对手，选举也能成功结束。每个诚实的参选人解出来的都是同一个密钥，也就是随机种子。

这就是Cardano多方计算的出来的结果。

### VRF

Verifiable random function (VRF) ，同样是计算随机元的一个方法，其应用代表是Algorand和Dfinity 。VRF的描述其实很简单：

它是一种伪随机函数，可以在不提供输入值的情况下，验证结果的正确性。给定输入值x，秘钥SK的所有者可以计算函数值y = FSK（x）和证明pSK（x）。 使用证明和公钥&lt;math&gt; PK = g ^ {SK} &lt;/ math&gt;，每个人都可以检查值y = FSK（x）是否确实正确计算，整个过程并不需要用到所有者的私钥。


### 伪随机数源

随机数分为真随机数和伪随机数，真随机数是真是发生在现实中的随机事件产生的结果，比如扔硬币，扔骰子等等，伪随机数是用确定性的算法计算出来自[0,1]均匀分布的随机数序列，其实伪随机数并不是真正意义上的随机数。因为产生伪随机数是用确定的算法，那么只要是输入是一样的，那么输出肯定是一样的，也就意味着，输入源一旦被确定，那么输出是肯定会被知道的。

PoS出块人不能被提前被人预测出来，如果顺序能被知道，那么出块人提前勾结形成卡特尔组织，对系统是有一定危害的（在没有出现抵押金-抵扣的策略之前，这种攻击代价更小）。所以，PoS中的随机算法输入源显得非常非常重要。

在Tezos中，要求在下一个选举周期之前，该周期所有出块人必须披露一个Nonce，所有的Nonce会被收集到一个列表，通过Scrypt密钥衍生函数得出种子，该种子用于下个选择周期的随机种子输入源。

EOS中，在每个出块周期开始时，会根据持币人所投票数选出21个区块生产者。被选中的区块生产者的顺序会根据15个及以上的区块生产者的同意，制定出块顺序的安排。

在Cadona中，使用多方计算（multiparty computation (MPC) ）的方法来获取随机种子，简称扔硬币（Coin tossing）。简单来说就是这个方法模拟了现实中扔骰子的过程，来最终确定随机种子的生成，需要每个出块人都扔一次硬币得到一个随机数，然后互相分享扔硬币的结果，然后对所有结果进行种子生成，如果所有人都生成了一样的结果，那么说明大家互相使用了一样的结果。这就确认了种子生成。

Cadano和Tezos的随机种子生成很相似，只不过实现细节上有不一样。Cadano用多方计算保证了即使有人没有分享结果，也能通过部分结果恢复成整体。而Tezos要求每个出块人都批量Nonce，否则会被扣除抵押金（Slash）。相当于Cadano用了数学的方法解决了批量的问题，Tezos用了规则来限定，各有千秋了。

## 3.5 打包交易


## 3.6 广播交易


## 3.7 验证人确认

